# 設計書

## 概要

この設計書は、Baukis2 RailsアプリケーションをRails 8の機能とベストプラクティスを完全に活用するための包括的なアップグレードについて説明します。アプリケーションは既にRails 8.0.2.1で動作していますが、いくつかの設定ファイル、ツールセットアップ、アーキテクチャパターンをRails 8標準に合わせてモダン化する必要があります。

アップグレードは段階的に実行され、各変更は個別にコミットされ、プルリクエストを通じてレビューされ、パックベースアーキテクチャの安定性と保守性を確保します。

## アーキテクチャ

### 現状分析
- Rails 8.0.2.1がインストールされているが、設定はまだRails 7.0のデフォルトを使用
- BinstubsがRailsではなくBundlerによって生成されている
- アセットパイプライン設定がRails 8の改善を活用していない可能性
- 一部のイニシャライザーと環境設定が古い可能性
- Packwerkによるパックベースアーキテクチャは機能しているが、Rails 8互換性の検証が必要

### 目標アーキテクチャ
- `config.load_defaults 8.0`による完全なRails 8準拠設定
- モダンなRails 8 binstubsとツール
- Rails 8の改善を活用した更新されたアセットパイプライン
- Rails 8互換のパックベースアーキテクチャ
- Rails 8標準によるモダンなJavaScriptバンドリング
- 強化されたセキュリティとパフォーマンス設定

## コンポーネントとインターフェース

### 1. コア設定の更新

#### アプリケーション設定 (`config/application.rb`)
- `config.load_defaults`を7.0から8.0に更新
- Rails 8用のジェネレーター設定の確認と更新
- パックベースパスがRails 8オートローディングと互換性があることを確認
- タイムゾーンと国際化設定の検証

#### 環境設定
- **開発環境**: Rails 8開発デフォルトへの更新、モダンなアセット処理の確保
- **本番環境**: Rails 8パフォーマンス最適化とセキュリティデフォルトの活用
- **テスト環境**: Rails 8互換性のためのテスト設定更新

### 2. Binstubsとツール

#### Rails Binstubsの更新
- `rails app:update:bin`を使用してRails binstubsを再生成
- すべてのbinstubsがBundler生成ではなくRails生成であることを確認
- 必要に応じて`.gitignore`を更新してbin/ディレクトリを含める
- すべての開発ツールが新しいbinstubsで動作することを検証

### 3. アセットパイプラインとJavaScript

#### モダンなアセット処理
- Rails 8用のアセットパイプライン設定の確認と更新
- JavaScriptバンドリングがRails 8標準で動作することを確認
- 必要に応じてWebpack設定を更新
- StimulusとTurbo設定がRails 8互換であることを検証

#### CSSとSass設定
- Rails 8互換性のためのSass設定更新
- すべての環境でアセットコンパイルが動作することを確認
- パック固有のアセットがRails 8で動作することを検証

### 4. データベースとActive Record

#### データベース設定
- Rails 8ベストプラクティスのためのdatabase.ymlの確認
- 接続プールとパフォーマンス設定が最適であることを確認
- Rails 8でのマイグレーション互換性の検証

#### Active Record設定
- Rails 8デフォルトを使用するためのActive Record設定更新
- クエリログとパフォーマンス監視が設定されていることを確認
- パックベースモデルがRails 8オートローディングで動作することを検証

### 5. パックアーキテクチャ互換性

#### Packwerk統合
- PackwerkがRails 8オートローディングで正しく動作することを検証
- パック固有のルートがRails 8ルーティングで動作することを確認
- パック依存関係とプライバシー強制のテスト
- Rails 8互換性のために必要に応じてパック設定を更新

#### パック固有設定
- Rails 8互換性のための各パック設定の確認
- パック固有のアセットとルートが正しく動作することを確認
- パックベーステストがRails 8で動作することを検証

### 6. セキュリティとパフォーマンス

#### セキュリティ設定
- Rails 8用のContent Security Policyの更新
- セキュリティヘッダーとミドルウェアの確認と更新
- CSRF保護がRails 8デフォルトを使用することを確認
- クッキーとセッション設定の更新

#### パフォーマンス最適化
- Rails 8パフォーマンス機能の有効化
- キャッシュ設定の更新
- ミドルウェアスタックの確認と最適化
- 適切なログと監視の確保

## データモデル

### 設定データフロー
```
Rails アプリ開始
    ↓
Rails 8.0 デフォルト読み込み
    ↓
環境固有設定の適用
    ↓
パックベースアーキテクチャの初期化
    ↓
パック固有設定の読み込み
    ↓
アプリケーションサービス開始
```

### アセット処理フロー
```
アセットリクエスト
    ↓
Rails 8 アセットパイプライン
    ↓
パック固有アセット解決
    ↓
Webpack/バンドリング（該当する場合）
    ↓
最適化されたアセット提供
```

## エラーハンドリング

### 設定検証
- Rails 8設定が適切に読み込まれることを確認するチェックの実装
- パックベースアーキテクチャ互換性の検証追加
- 設定不足に対する適切なフォールバックの確保

### アセットパイプラインエラーハンドリング
- アセットコンパイル失敗に対する適切なエラーメッセージ
- パック固有アセット不足に対するフォールバック戦略
- 開発環境と本番環境のエラーハンドリングの違い

### データベース接続エラーハンドリング
- 堅牢なデータベース接続エラーハンドリング
- マイグレーション問題に対する適切なエラーメッセージ
- 接続プールエラー回復

## テスト戦略

### 設定テスト
- Rails 8デフォルトが適切に読み込まれることのテスト
- 環境固有設定が正しく動作することの検証
- パックベースアーキテクチャ機能のテスト

### 統合テスト
- すべてのパックでのアセットパイプライン機能のテスト
- パックベース構造でルーティングが正しく動作することの検証
- データベース接続とActive Record機能のテスト

### 回帰テスト
- 既存機能が継続して動作することの確認
- すべてのパック固有機能のテスト
- パフォーマンス回帰がないことの検証

### 自動テスト
- Rails 8互換性のためのテスト設定更新
- RSpecがRails 8で正しく動作することの確認
- ファクトリ設定とテストデータセットアップのテスト

## 実装フェーズ

### フェーズ1: コア設定更新
1. `config.load_defaults`を8.0に更新
2. `rails app:update`を実行してRails 8設定を取得
3. 設定変更の確認とマージ
4. `rails app:update:bin`を使用してbinstubsを更新

### フェーズ2: 環境設定
1. 開発環境設定の更新
2. 本番環境設定の更新
3. テスト環境設定の更新
4. すべての環境が正しく動作することの検証

### フェーズ3: アセットパイプラインとJavaScript
1. アセットパイプライン設定の更新
2. JavaScriptバンドリングが正しく動作することの検証
3. パック固有アセットのテスト
4. CSS/Sass設定の更新

### フェーズ4: データベースとActive Record
1. データベース設定の確認と更新
2. Active Record機能のテスト
3. マイグレーション互換性の検証
4. 接続プール設定の更新

### フェーズ5: パックアーキテクチャ検証
1. Rails 8でのPackwerk互換性のテスト
2. パック固有ルートとコントローラーの検証
3. パック依存関係とプライバシーのテスト
4. 必要に応じてパック設定の更新

### フェーズ6: セキュリティとパフォーマンス
1. セキュリティ設定の更新
2. Rails 8パフォーマンス最適化の実装
3. ミドルウェアスタックの確認と更新
4. キャッシュとログ設定のテスト

### フェーズ7: テストと品質保証
1. テスト設定の更新
2. 包括的テストスイートの実行
3. パフォーマンステストと最適化
4. ドキュメント更新

## リスク軽減

### バックアップ戦略
- アップグレード開始前の包括的バックアップ作成
- アップグレードの各フェーズでのGitブランチ使用
- 各フェーズのロールバック手順の実装

### 互換性テスト
- パックベースアーキテクチャの徹底的なテスト
- すべての既存機能が動作することの検証
- 開発、ステージング、本番環境でのテスト

### パフォーマンス監視
- アップグレード中のアプリケーションパフォーマンス監視
- パフォーマンス回帰の特定と対処
- 監視データに基づく設定の最適化