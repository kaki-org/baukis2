# 設計書

## 概要

この設計書は、Baukis2 Rails アプリケーションを Rails 8 の機能とベストプラクティスを完全に活用するための包括的なアップグレードについて説明します。アプリケーションは既に Rails 8.0.2.1 で動作していますが、いくつかの設定ファイル、ツールセットアップ、アーキテクチャパターンを Rails 8 標準に合わせてモダン化する必要があります。

アップグレードは段階的に実行され、各変更は個別にコミットされ、プルリクエストを通じてレビューされ、パックベースアーキテクチャの安定性と保守性を確保します。

## アーキテクチャ

### 現状分析

- Rails 8.0.2.1 がインストールされているが、設定はまだ Rails 7.0 のデフォルトを使用
- Binstubs が Rails ではなく Bundler によって生成されている
- アセットパイプライン設定が Rails 8 の改善を活用していない可能性
- 一部のイニシャライザーと環境設定が古い可能性
- Packwerk によるパックベースアーキテクチャは機能しているが、Rails 8 互換性の検証が必要

### 目標アーキテクチャ

- `config.load_defaults 8.0`による完全な Rails 8 準拠設定
- モダンな Rails 8 binstubs とツール
- Rails 8 の改善を活用した更新されたアセットパイプライン
- Rails 8 互換のパックベースアーキテクチャ
- Rails 8 標準によるモダンな JavaScript バンドリング
- 強化されたセキュリティとパフォーマンス設定

## コンポーネントとインターフェース

### 1. コア設定の更新

#### アプリケーション設定 (`config/application.rb`)

- `config.load_defaults`を 7.0 から 8.0 に更新
- Rails 8 用のジェネレーター設定の確認と更新
- パックベースパスが Rails 8 オートローディングと互換性があることを確認
- タイムゾーンと国際化設定の検証

#### 環境設定

- **開発環境**: Rails 8 開発デフォルトへの更新、モダンなアセット処理の確保
- **本番環境**: Rails 8 パフォーマンス最適化とセキュリティデフォルトの活用
- **テスト環境**: Rails 8 互換性のためのテスト設定更新

### 2. Binstubs とツール

#### Rails Binstubs の更新

- `rails app:update:bin`を使用して Rails binstubs を再生成
- すべての binstubs が Bundler 生成ではなく Rails 生成であることを確認
- 必要に応じて`.gitignore`を更新して bin/ディレクトリを含める
- すべての開発ツールが新しい binstubs で動作することを検証

### 3. アセットパイプラインと JavaScript

#### モダンなアセット処理

- Rails 8 用のアセットパイプライン設定の確認と更新
- JavaScript バンドリングが Rails 8 標準で動作することを確認
- 必要に応じて Webpack 設定を更新
- Stimulus と Turbo 設定が Rails 8 互換であることを検証

#### CSS と Sass 設定

- Rails 8 互換性のための Sass 設定更新
- すべての環境でアセットコンパイルが動作することを確認
- パック固有のアセットが Rails 8 で動作することを検証

### 4. データベースと Active Record

#### データベース設定

- Rails 8 ベストプラクティスのための database.yml の確認
- 接続プールとパフォーマンス設定が最適であることを確認
- Rails 8 でのマイグレーション互換性の検証

#### Active Record 設定

- Rails 8 デフォルトを使用するための Active Record 設定更新
- クエリログとパフォーマンス監視が設定されていることを確認
- パックベースモデルが Rails 8 オートローディングで動作することを検証

### 5. パックアーキテクチャ互換性

#### Packwerk 統合

- Packwerk が Rails 8 オートローディングで正しく動作することを検証
- パック固有のルートが Rails 8 ルーティングで動作することを確認
- パック依存関係とプライバシー強制のテスト
- Rails 8 互換性のために必要に応じてパック設定を更新

#### パック固有設定

- Rails 8 互換性のための各パック設定の確認
- パック固有のアセットとルートが正しく動作することを確認
- パックベーステストが Rails 8 で動作することを検証

### 6. セキュリティとパフォーマンス

#### セキュリティ設定

- Rails 8 用の Content Security Policy の更新
- セキュリティヘッダーとミドルウェアの確認と更新
- CSRF 保護が Rails 8 デフォルトを使用することを確認
- クッキーとセッション設定の更新

#### パフォーマンス最適化

- Rails 8 パフォーマンス機能の有効化
- キャッシュ設定の更新
- ミドルウェアスタックの確認と最適化
- 適切なログと監視の確保

## データモデル

### 設定データフロー

```
Rails アプリ開始
    ↓
Rails 8.0 デフォルト読み込み
    ↓
環境固有設定の適用
    ↓
パックベースアーキテクチャの初期化
    ↓
パック固有設定の読み込み
    ↓
アプリケーションサービス開始
```

### アセット処理フロー

```
アセットリクエスト
    ↓
Rails 8 アセットパイプライン
    ↓
パック固有アセット解決
    ↓
Webpack/バンドリング（該当する場合）
    ↓
最適化されたアセット提供
```

## エラーハンドリング

### 設定検証

- Rails 8 設定が適切に読み込まれることを確認するチェックの実装
- パックベースアーキテクチャ互換性の検証追加
- 設定不足に対する適切なフォールバックの確保

### アセットパイプラインエラーハンドリング

- アセットコンパイル失敗に対する適切なエラーメッセージ
- パック固有アセット不足に対するフォールバック戦略
- 開発環境と本番環境のエラーハンドリングの違い

### データベース接続エラーハンドリング

- 堅牢なデータベース接続エラーハンドリング
- マイグレーション問題に対する適切なエラーメッセージ
- 接続プールエラー回復

## テスト戦略

### 設定テスト

- Rails 8 デフォルトが適切に読み込まれることのテスト
- 環境固有設定が正しく動作することの検証
- パックベースアーキテクチャ機能のテスト

### 統合テスト

- すべてのパックでのアセットパイプライン機能のテスト
- パックベース構造でルーティングが正しく動作することの検証
- データベース接続と Active Record 機能のテスト

### 回帰テスト

- 既存機能が継続して動作することの確認
- すべてのパック固有機能のテスト
- パフォーマンス回帰がないことの検証

### 自動テスト

- Rails 8 互換性のためのテスト設定更新
- RSpec が Rails 8 で正しく動作することの確認
- ファクトリ設定とテストデータセットアップのテスト

## 実装フェーズ

### フェーズ 1: コア設定更新

1. `config.load_defaults`を 8.0 に更新
2. `rails app:update`を実行して Rails 8 設定を取得
3. 設定変更の確認とマージ
4. `rails app:update:bin`を使用して binstubs を更新

### フェーズ 2: 環境設定

1. 開発環境設定の更新
2. 本番環境設定の更新
3. テスト環境設定の更新
4. すべての環境が正しく動作することの検証

### フェーズ 3: アセットパイプラインと JavaScript

1. アセットパイプライン設定の更新
2. JavaScript バンドリングが正しく動作することの検証
3. パック固有アセットのテスト
4. CSS/Sass 設定の更新

### フェーズ 4: データベースと Active Record

1. データベース設定の確認と更新
2. Active Record 機能のテスト
3. マイグレーション互換性の検証
4. 接続プール設定の更新

### フェーズ 5: パックアーキテクチャ検証

1. Rails 8 での Packwerk 互換性のテスト
2. パック固有ルートとコントローラーの検証
3. パック依存関係とプライバシーのテスト
4. 必要に応じてパック設定の更新

### フェーズ 6: セキュリティとパフォーマンス

1. セキュリティ設定の更新
2. Rails 8 パフォーマンス最適化の実装
3. ミドルウェアスタックの確認と更新
4. キャッシュとログ設定のテスト

### フェーズ 7: テストと品質保証

1. テスト設定の更新
2. 包括的テストスイートの実行
3. パフォーマンステストと最適化
4. ドキュメント更新

## リスク軽減

### バックアップ戦略

- アップグレード開始前の包括的バックアップ作成
- アップグレードの各フェーズでの Git ブランチ使用
- 各フェーズのロールバック手順の実装

### 互換性テスト

- パックベースアーキテクチャの徹底的なテスト
- すべての既存機能が動作することの検証
- 開発、ステージング、本番環境でのテスト

### パフォーマンス監視

- アップグレード中のアプリケーションパフォーマンス監視
- パフォーマンス回帰の特定と対処
- 監視データに基づく設定の最適化
